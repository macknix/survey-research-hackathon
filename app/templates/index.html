<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSV Upload and Preview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f5f5f7;
    }

    h1 {
      margin-top: 0;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      max-width: 800px;
    }

    .row {
      margin-bottom: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      cursor: pointer;
      font-size: 0.95rem;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    #status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    #status.error {
      color: #b91c1c;
    }

    #status.success {
      color: #166534;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
      background: #ffffff;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      background: #f3f4f6;
    }

    .table-container {
      max-height: 400px;
      overflow: auto;
      margin-top: 1rem;
    }

    small {
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>CSV Upload &amp; Preview</h1>
    <p>
      Select a CSV file and upload.
    </p>

    <div class="row">
      <input type="file" id="csv-file" accept=".csv,text/csv" />
      <button id="upload-btn">Upload &amp; Preview</button>
      <div id="status"></div>
    </div>

    <div class="row">
      <small id="summary"></small>
    </div>

    <div class="table-container" id="table-container"></div>


    <hr />

    <div class="row">
      <label for="n-clusters"><strong>Number of clusters:</strong></label>
      <input type="number" id="n-clusters" min="2" max="20" value="5" style="width:4em; margin-right:1em;">
      <button id="run-clustering-btn">Run Clustering &amp; Show Plot</button>
      <span id="clustering-status" style="margin-left:1em;"></span>
    </div>
    <div class="row">
      <img id="clustering-plot" src="" alt="Cluster Wordclouds" style="display:none; max-width:100%; border:1px solid #ccc; border-radius:6px;" />
    </div>

    <div class="row">
      <label for="column-select"><strong>Column to classify:</strong></label>
      <select id="column-select">
        <option value="">-- Upload a CSV first --</option>
      </select>
    </div>

    <div class="row">
      <strong>Topics</strong> (add, edit, or remove as needed):
      <button id="add-topic-btn" style="margin-left:1em;">Add Topic</button>
    </div>

    <div class="table-container" id="topics-container"></div>

    <div class="row">
      <button id="build-prompt-btn">Build LangChain Pydantic prompt</button>
    </div>

    <div class="row">
      <label for="prompt-output"><strong>Generated prompt:</strong></label>
      <textarea id="prompt-output" rows="8" style="width: 100%; font-family: monospace;"></textarea>
    </div>

    <hr />

    <div class="row">
      <label for="model-select"><strong>LLM Model:</strong></label>
      <select id="model-select">
        <option value="gpt-oss:120b-cloud">gpt-oss:120b-cloud</option>
        <option value="mistral">mistral</option>
        <option value="phi3">phi3</option>
        <option value="mixtral">mixtral</option>
      </select>
      <label for="batch-size" style="margin-left:2em;"><strong>Batch size:</strong></label>
      <input type="number" id="batch-size" min="1" max="100" value="10" style="width:4em;">
      <button id="run-classify-btn">Run Classification</button>
    </div>

    <div class="row">
      <div id="classify-status"></div>
    </div>

    <div class="table-container" id="classified-table-container"></div>
  </div>

  <script>
  // --- CLUSTERING UI ---
  const runClusteringBtn = document.getElementById("run-clustering-btn");
  const clusteringStatus = document.getElementById("clustering-status");
  const clusteringPlot = document.getElementById("clustering-plot");

  runClusteringBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    const nClustersInput = document.getElementById("n-clusters");
    const nClusters = parseInt(nClustersInput.value) || 5;
    if (!file) {
      clusteringStatus.textContent = "Please choose a CSV file first.";
      return;
    }
    if (!columnSelect.value) {
      clusteringStatus.textContent = "Select a column to cluster.";
      return;
    }
    clusteringStatus.textContent = "Running clustering...";
    clusteringPlot.style.display = "none";
    const formData = new FormData();
    formData.append("file", file);
    formData.append("column", columnSelect.value);
    formData.append("n_clusters", nClusters);
    try {
      const response = await fetch("/run_clustering", {
        method: "POST",
        body: formData
      });
      const result = await response.json();
      if (!result.success) {
        clusteringStatus.textContent = result.error || "Clustering failed.";
        return;
      }
      clusteringStatus.textContent = "Clustering complete!";
      clusteringPlot.src = result.plot_url + "?t=" + Date.now(); // bust cache
      clusteringPlot.style.display = "block";
    } catch (err) {
      clusteringStatus.textContent = "Network or server error.";
      console.error(err);
    }
  });
  const fileInput = document.getElementById("csv-file");
  const uploadBtn = document.getElementById("upload-btn");
  const statusDiv = document.getElementById("status");
  const tableContainer = document.getElementById("table-container");
  const summary = document.getElementById("summary");
  const columnSelect = document.getElementById("column-select");
  const addTopicBtn = document.getElementById("add-topic-btn");
  const buildPromptBtn = document.getElementById("build-prompt-btn");
  const promptOutput = document.getElementById("prompt-output");
  let currentColumns = [];
  let currentRows = [];
  let currentTopics = [];
  let classifiedRows = [];
  const modelSelect = document.getElementById("model-select");
  const batchSizeInput = document.getElementById("batch-size");
  const runClassifyBtn = document.getElementById("run-classify-btn");
  const classifyStatus = document.getElementById("classify-status");
  const classifiedTableContainer = document.getElementById("classified-table-container");
  function renderClassifiedTable(columns, rows) {
    if (!columns || columns.length === 0 || !rows || rows.length === 0) {
      classifiedTableContainer.innerHTML = "<p>No classified data yet.</p>";
      return;
    }
    let html = "<table><thead><tr>";
    for (const col of columns) {
      html += `<th>${col}</th>`;
    }
    html += "</tr></thead><tbody>";
    for (const row of rows) {
      html += "<tr>";
      for (const col of columns) {
        const value = row[col];
        html += `<td>${value !== undefined ? value : ""}</td>`;
      }
      html += "</tr>";
    }
    html += "</tbody></table>";
    classifiedTableContainer.innerHTML = html;
  }
  runClassifyBtn.addEventListener("click", async () => {
    if (!currentRows || currentRows.length === 0) {
      classifyStatus.textContent = "Upload a CSV first.";
      return;
    }
    if (!columnSelect.value) {
      classifyStatus.textContent = "Select a column to classify.";
      return;
    }
    if (!currentTopics || currentTopics.length === 0) {
      classifyStatus.textContent = "Add at least one topic.";
      return;
    }
    const model = modelSelect.value;
    const batchSize = parseInt(batchSizeInput.value) || 10;
    classifyStatus.textContent = "Running classification...";
    classifiedTableContainer.innerHTML = "";
    try {
      const response = await fetch("/classify_rows", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          column: columnSelect.value,
          rows: currentRows,
          topics: currentTopics,
          model,
          batch_size: batchSize
        })
      });
      if (!response.ok) {
        classifyStatus.textContent = `Server error: ${response.status}`;
        return;
      }
      const result = await response.json();
      if (!result.success) {
        classifyStatus.textContent = result.error || "Unknown error.";
        return;
      }
      classifiedRows = result.rows;
      renderClassifiedTable(result.columns, result.rows);
      classifyStatus.textContent = `Classified ${result.rows.length} rows.`;
    } catch (err) {
      classifyStatus.textContent = "Network or server error.";
      console.error(err);
    }
  });

    function setStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = "";
      if (type) {
        statusDiv.classList.add(type);
      }
    }

  function renderTable(columns, rows) {
      if (!columns || columns.length === 0) {
        tableContainer.innerHTML = "<p>No data to display.</p>";
        return;
      }

      let html = "<table><thead><tr>";
      for (const col of columns) {
        html += `<th>${col}</th>`;
      }
      html += "</tr></thead><tbody>";

      for (const row of rows) {
        html += "<tr>";
        for (const col of columns) {
          const value = row[col];
          html += `<td>${value !== undefined ? value : ""}</td>`;
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      tableContainer.innerHTML = html;
    }

    function renderTopics(topics) {
      const container = document.getElementById("topics-container");
      if (!topics || topics.length === 0) {
        container.innerHTML = "<p>No topics yet. Add one!</p>";
        return;
      }

      let html = "<table><thead><tr>";
      html += "<th>Topic ID</th><th>Label</th><th>Description</th><th>Actions</th>";
      html += "</tr></thead><tbody>";

      for (let i = 0; i < topics.length; i++) {
        const t = topics[i];
        html += `<tr data-idx="${i}">`;
        html += `<td><input type="number" min="1" value="${t.id ?? ''}" class="topic-id-input" style="width:4em;"></td>`;
        html += `<td><input type="text" value="${t.label ?? ''}" class="topic-label-input"></td>`;
        html += `<td><input type="text" value="${t.description ?? ''}" class="topic-desc-input" style="width:100%"></td>`;
        html += `<td><button class="remove-topic-btn">Remove</button></td>`;
        html += "</tr>";
      }

      html += "</tbody></table>";
      container.innerHTML = html;

      // Wire up remove buttons
      container.querySelectorAll('.remove-topic-btn').forEach((btn, idx) => {
        btn.addEventListener('click', () => {
          currentTopics.splice(idx, 1);
          renderTopics(currentTopics);
        });
      });

      // Wire up input changes
      container.querySelectorAll('tr[data-idx]').forEach((row, idx) => {
        row.querySelector('.topic-id-input').addEventListener('input', e => {
          currentTopics[idx].id = parseInt(e.target.value) || '';
        });
        row.querySelector('.topic-label-input').addEventListener('input', e => {
          currentTopics[idx].label = e.target.value;
        });
        row.querySelector('.topic-desc-input').addEventListener('input', e => {
          currentTopics[idx].description = e.target.value;
        });
      });
    }

  uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        setStatus("Please choose a CSV file first.", "error");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      uploadBtn.disabled = true;
      setStatus("Uploading and parsing CSV…", null);
      summary.textContent = "";
      tableContainer.innerHTML = "";

      try {
        const response = await fetch("/upload_csv", {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          setStatus(`Server error: ${response.status}`, "error");
          uploadBtn.disabled = false;
          return;
        }

        const result = await response.json();
        if (!result.success) {
          setStatus(result.error || "Unknown error parsing CSV.", "error");
        } else {
          setStatus("CSV parsed successfully.", "success");
          renderTable(result.columns, result.rows);
          summary.textContent = `Showing first ${result.rows.length} rows out of ${result.row_count} total rows.`;

          currentColumns = result.columns || [];
          currentRows = result.rows || [];

          // Populate column dropdown
          columnSelect.innerHTML = "";
          if (currentColumns.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "-- No columns found --";
            columnSelect.appendChild(opt);
          } else {
            for (const col of currentColumns) {
              const opt = document.createElement("option");
              opt.value = col;
              opt.textContent = col;
              columnSelect.appendChild(opt);
            }
          }

          // Reset topics and prompt
          currentTopics = [];
          renderTopics(currentTopics);
          promptOutput.value = "";
        }
      } catch (err) {
        setStatus("Network or server error. Check the console.", "error");
        console.error(err);
      } finally {
        uploadBtn.disabled = false;
      }
    });


    addTopicBtn.addEventListener('click', () => {
      // Add a new topic with next available id
      const nextId = (currentTopics.length > 0)
        ? Math.max(...currentTopics.map(t => t.id || 0)) + 1
        : 1;
      currentTopics.push({ id: nextId, label: '', description: '' });
      renderTopics(currentTopics);
    });

    buildPromptBtn.addEventListener("click", async () => {
      if (!currentTopics || currentTopics.length === 0) {
        setStatus("Add at least one topic first.", "error");
        return;
      }

      setStatus("Building LangChain Pydantic parser prompt…", null);

      try {
        const response = await fetch("/build_prompt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            topics: currentTopics,
          }),
        });

        if (!response.ok) {
          setStatus(`Server error building prompt: ${response.status}`, "error");
          return;
        }

        const result = await response.json();
        if (!result.success) {
          setStatus(result.error || "Unknown error building prompt.", "error");
          return;
        }

        promptOutput.value = result.prompt || "";
        setStatus("Prompt built successfully.", "success");
      } catch (err) {
        console.error(err);
        setStatus("Network or server error while building prompt.", "error");
      }
    });
  </script>
</body>
</html>